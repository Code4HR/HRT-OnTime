<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.css" />
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.1.0-rc.1/jquery.mobile-1.1.0-rc.1.min.js"></script>
    
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    
<script type="text/javascript">
    console.log('hello');

/**************
 * Classes
 *************/
    function Bus(num, route, direction, adherence, time, lat, lon) {
        this.num = num;
        this.route = route;
        this.direction = direction;
        this.adherence = adherence;
        this.time = time;
        this.lat = lat;
        this.lon = lon;
    }

/********************
 * Private Functions
 *******************/

    // Here's where the magic happens
    function getBuses(checkins, route) {
        var buses = [];
        var busIds = [];
        
        // Go through all the checkins and find out which buses are on the route in question
        console.log('getting bus ids for route ' + route);
        $.each(checkins, function(i, checkin) {
            if(checkin.Route == route) {
                busIds.push(checkin.BusId);
                console.log('Adding bus ' + checkin.BusId + ' at time ' + checkin.CheckinTime)
                buses.push(new Bus(
                                    checkin.BusId,
                                    checkin.Route,
                                    checkin.Direction,
                                    checkin.Adherence,
                                    checkin.CheckinTime,
                                    checkin.Lat,
                                    checkin.Lon));
            }
        });
        
        return buses;
    }
    
    // Grab the data from our file
    function getCheckins(onComplete) {
        console.log('getting checkins');
        $.getJSON('http://dl.dropbox.com/u/126246/hrt_bus_data.json', onComplete);
    }
    
/********************
 * API Functions
 *******************/
    // Call this function!
    // Give it a route and a callback
    // Once it's done, it will use the callback to send an array of Bus objects
    // representing the most recent location of every bus on that route 
    function getBusesOnRoute(route, onBusesFound) {
        getCheckins(function(data) {
                        console.log('got checkins');
                        onBusesFound(getBuses(data, route));
                    });
    }

/********************
 * Do Work
 *******************/
    var map;
    function showMap(position) {
        var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        var myOptions = {
            zoom: 11,
            center: latlng,
            mapTypeControl: false,
            navigationControlOptions: {style: google.maps.NavigationControlStyle.SMALL},
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var mapcanvas = $('#mapcanvas');
        map = new google.maps.Map(mapcanvas[0], myOptions);
        var marker = new google.maps.Marker({
            position: latlng, 
            map: map, 
            title:"I am here!"
        });
    }
    
    function presentBuses(buses) {
        console.log('PRESNTING!');
        console.log(buses);
        
        $.each(buses, function(i, bus) {
            var latlng = new google.maps.LatLng(bus.lat, bus.lon);
            var marker = new google.maps.Marker({
                position: latlng, 
                map: map, 
                animation: google.maps.Animation.DROP,
                title:'Bus ' + bus.num + ' is ' + bus.adherence + ' min late',
                icon: 'http://dl.dropbox.com/u/126246/bus.png'
            });
            
            var contentString = 'Bus #' + bus.num + ' traveling ';
            if(bus.direction == 1) contentString += 'Outbound is ';
            else contentString += 'Inbound is ';
            if(bus.adherence == 0) contentString += 'On Time.';
            else if(bus.adherence > 0) contentString += bus.adherence + ' minutes Early.';
            else contentString += (bus.adherence*-1) + ' minutes Late.';
            contentString += '<br>Last Checkin at ' + bus.time;
            
            var infowindow = new google.maps.InfoWindow({
                    content: contentString
                });
            google.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map,marker);
            });
        });
    }
    
    function showBuses() {
        getBusesOnRoute($("#routeNumber").val(), presentBuses);
    }
    
    function error(msg) {
        var errMsg = typeof msg == 'string' ? msg : "Geolocation failed";
        $('#msg').html(errMsg);
    }
    
    $(document).ready(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showMap, error);
        } else {
            error('Geolocation not supported');
        }
    });
</script>
</head>
<body>
    <div data-role="header">
        <h3>HRT Buses</h3>
    </div>

    <div data-role="content">
        <label for="routeNumber">Route Number</label>
        <input id="routeNumber" type="text" value=""/>
        
        <a href="" data-role="button" onClick="showBuses();">Find Buses</a>
    </div>

    <div id="msg"></div>
    <div id="mapcanvas" style="height: 400px; width: 100%;"></div>
</body>
</html>