<html>
<head>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
    console.log('hello');

/**************
 * Classes
 *************/
	function Bus(id, route, date, time, lat, lon) {
		this.id = id;
		this.route = route;
		this.date = date;
		this.time = time;
		this.lat = lat;
		this.lon = lon;
	}

/********************
 * Private Functions
 *******************/

	// Here's where the magic happens
	// Notes about the data we are pulling from couch at the time this code was written:
	// 1. Most of the checkins don't have a route associated with them.
	// 2. The checkins are not in chronological order.
	function getBuses(checkins, route) {
		var buses = [];
		var busIds = [];
		
		// Go through all the checkins and find out which buses are on the route in question
		console.log('getting bus ids for route ' + route);
		$.each(checkins, function(i, checkin) {
			if(checkin.doc.route == route && jQuery.inArray(checkin.doc.vehicle, busIds) == -1) {
				busIds.push(checkin.doc.vehicle);
				console.log('Adding bus ' + checkin.doc.vehicle + ' at time ' + checkin.doc.time)
				buses.push(new Bus(
									checkin.doc.vehicle,
									checkin.doc.route,
									checkin.doc.date,
									checkin.doc.time,
									checkin.doc["lat/lon"][0],
									checkin.doc["lat/lon"][1]));
			}
		});
		
		// Now that we have a list of the buses on the route, we need to find the most
		// recent checkin for each bus.
		console.log('getting most recent checkins for each bus');
		$.each(checkins, function(i, checkin) {
			$.each(buses, function(j, bus) {
				if(bus.id == checkin.doc.vehicle && bus.time < checkin.doc.time)
				{
					//console.log('found newer time for bus ' + bus.id)
					bus.time = checkin.doc.time;
					bus.lat = checkin.doc["lat/lon"][0];
					bus.lon = checkin.doc["lat/lon"][1];
				}
			});
		});
		
		return buses;
	}
	
	// Grab the data from IrisCouchDB
	// Currently, we expect the db to have a couple days of static data
	// and we pull the first 3000 rows
	function getCheckins(onComplete) {
		console.log('getting checkins');
		$.getJSON('http://hrt.iriscouch.com/hrtransit/_all_docs?limit=3000&include_docs=true&callback=?', onComplete);
	}
	
/********************
 * API Functions
 *******************/
	// Call this function!
	// Give it a route and a callback
	// Once it's done, it will use the callback to send an array of Bus objects
	// representing the most recent location of every bus on that route 
	function getBusesOnRoute(route, onBusesFound) {
		getCheckins(function(data) {
						console.log('got checkins');
						onBusesFound(getBuses(data.rows, route));
		  			});
	}

/********************
 * Example
 *******************/
	function presentBuses(buses) {
		console.log('PRESNTING!');
		console.log(buses);
	}
	
	getBusesOnRoute(6, presentBuses);
	
</script>
</head>
<body>
  <!-- we will add our HTML content here -->
</body>
</html>